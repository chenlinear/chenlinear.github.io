<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Liste - https://ChenLi2049.github.io"><title>Machine Learning Notes: GNN, GraphNeT | Chen Li</title><meta name=description content="Chen Li's personal blog"><meta property="og:title" content="Machine Learning Notes: GNN, GraphNeT"><meta property="og:description" content="§1 Graph A graph is a data structure that has the shape $\mathbb{R} ^{N \times P}$, where
$N$ is the number of nodes. Note that $N$ might vary in a dataset, but we often use cutting or padding to get a uniform, normalized $N$. $P$ is the number of features. Yes, the concept of &ldquo;features&rdquo; is similar to the concept of &ldquo;channels&rdquo; in CNNs. A picture $\mathbb{R}^{H \times W \times C}$ is of height $H$ and width $W$, thus the total number of pixels is $HW$, and each pixel has $C$ channels, commonly $C=1$ (grep channel) or $C=3$ (RGB channels)."><meta property="og:type" content="article"><meta property="og:url" content="https://ChenLi2049.github.io/posts/20230910-machine-learning-notes-gnn-graphnet/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-10T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-10T00:00:00+00:00"><meta itemprop=name content="Machine Learning Notes: GNN, GraphNeT"><meta itemprop=description content="§1 Graph A graph is a data structure that has the shape $\mathbb{R} ^{N \times P}$, where
$N$ is the number of nodes. Note that $N$ might vary in a dataset, but we often use cutting or padding to get a uniform, normalized $N$. $P$ is the number of features. Yes, the concept of &ldquo;features&rdquo; is similar to the concept of &ldquo;channels&rdquo; in CNNs. A picture $\mathbb{R}^{H \times W \times C}$ is of height $H$ and width $W$, thus the total number of pixels is $HW$, and each pixel has $C$ channels, commonly $C=1$ (grep channel) or $C=3$ (RGB channels)."><meta itemprop=datePublished content="2023-09-10T00:00:00+00:00"><meta itemprop=dateModified content="2023-09-10T00:00:00+00:00"><meta itemprop=wordCount content="3042"><meta itemprop=keywords content="programming,"><link rel=canonical href=https://ChenLi2049.github.io/posts/20230910-machine-learning-notes-gnn-graphnet/><link rel=icon href=https://ChenLi2049.github.io/assets/favicon.ico><link rel=dns-prefetch href=https://www.google-analytics.com><link href=https://www.google-analytics.com rel=preconnect crossorigin><link rel=alternate type=application/atom+xml title="Chen Li" href=https://ChenLi2049.github.io/atom.xml><link rel=alternate type=application/json title="Chen Li" href=https://ChenLi2049.github.io/feed.json><link rel="shortcut icon" type=image/png href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII="><style>*,:after,:before{box-sizing:border-box;padding:0}body{font:1rem/1.5 '-apple-system',BlinkMacSystemFont,avenir next,avenir,helvetica,helvetica neue,ubuntu,roboto,noto,segoe ui,arial,sans-serif;text-align:justify;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:2rem;background:rbg(169,169,169,1);color:#000}.skip-link{position:absolute;top:-40px;left:0;background:#eee;z-index:100}.skip-link:focus{top:0}h1,h2,h3,h4,h5{font-size:20px;font-weight:600;text-align:center}strong,b{font-size:inherit;font-weight:600}header{line-height:2;padding-bottom:1.5rem}.link{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.time{font-variant-numeric:tabular-nums;white-space:nowrap}blockquote{border-left:5px solid #eee;padding-left:1rem;margin:0}a:hover,a.heading-link{text-decoration:none}a,a:visited{color:#008b8b}pre{padding:.5rem;overflow:auto;overflow-x:scroll;overflow-wrap:normal}code,pre{font-family:San Francisco Mono,Monaco,consolas,lucida console,dejavu sans mono,bitstream vera sans mono,monospace;font-size:normal;font-size:small;background:#eee}code{margin:.1rem;border:none}ul{list-style-type:circle}ul,ol{padding-left:1.2rem}.list{line-height:2;list-style-type:none;padding-left:0}.list li{padding-bottom:.1rem}.meta{color:#777}.content{max-width:90ch;margin:0 auto}header{line-height:1;display:flex;justify-content:space-between;padding-bottom:1rem}header a{text-decoration:none}header ul{list-style-type:none;padding:0}header li,header a{display:inline}h2.post{padding-top:.5rem}header ul a:first-child{padding-left:1rem}.nav{height:1px;background:#000;content:'';max-width:10%}.list li{display:flex;align-items:baseline}.list li time{flex:initial}.hr-list{margin-top:0;margin-bottom:0;margin-right:.5rem;margin-left:.5rem;height:1px;border:0;border-bottom:1px dotted #ccc;flex:1 0 1rem}.m,hr{border:0;margin:3rem 0}img{max-width:100%;height:auto}.post-date{margin:5% 0}.index-date{color:#9a9a9a}.animate-blink{animation:opacity 1s infinite;opacity:1}@keyframes opacity{0%{opacity:1}50%{opacity:.5}100%{opacity:0}}.tags{display:flex;justify-content:space-between}.tags ul{padding:0;margin:0}.tags li{display:inline}.avatar{height:135px;width:135px;position:relative;margin:0 0 0 15px;float:right;border-radius:25%}table{border-collapse:collapse}table th,table td{border:1px solid #bebebe;padding:0 5px}.toc{margin:0 auto;width:100%;padding:0;margin-bottom:10px;background-color:#f9f9f9}</style><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"posts","name":"Machine Learning Notes: GNN, GraphNeT","headline":"Machine Learning Notes: GNN, GraphNeT","alternativeHeadline":"","description":"§1 Graph A graph is a data structure that has the shape $\\mathbb{R} ^{N \\times P}$, where\n$N$ is the number of nodes. Note that $N$ might vary in a dataset, but we often use cutting or padding to get a uniform, normalized $N$. $P$ is the number of features. Yes, the concept of \u0026ldquo;features\u0026rdquo; is similar to the concept of \u0026ldquo;channels\u0026rdquo; in CNNs. A picture $\\mathbb{R}^{H \\times W \\times C}$ is of height $H$ and width $W$, thus the total number of pixels is $HW$, and each pixel has $C$ channels, commonly $C=1$ (grep channel) or $C=3$ (RGB channels).","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ChenLi2049.github.io\/posts\/20230910-machine-learning-notes-gnn-graphnet\/"},"author":{"@type":"Person","name":"Chen Li"},"creator":{"@type":"Person","name":"Chen Li"},"accountablePerson":{"@type":"Person","name":"Chen Li"},"copyrightHolder":"Chen Li","copyrightYear":"2023","dateCreated":"2023-09-10T00:00:00.00Z","datePublished":"2023-09-10T00:00:00.00Z","dateModified":"2023-09-10T00:00:00.00Z","publisher":{"@type":"Organization","name":"Chen Li","url":"https://ChenLi2049.github.io","logo":{"@type":"ImageObject","url":"https:\/\/ChenLi2049.github.io\/assets\/favicon.ico","width":"32","height":"32"}},"image":"https://ChenLi2049.github.io/assets/favicon.ico","url":"https:\/\/ChenLi2049.github.io\/posts\/20230910-machine-learning-notes-gnn-graphnet\/","wordCount":"3042","genre":["programming"],"keywords":["programming"]}</script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.6/katex.min.css><script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.6/katex.min.js></script>
<script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.6/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><script src=https://cdn.jsdelivr.net/npm/@xiee/utils/js/tabsets.min.js defer></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@xiee/utils/css/tabsets.min.css></head><body><a class=skip-link href=#main>Skip to main</a><main id=main><div class=content><header><p style=padding:0;margin:0><a href=/><b>Chen Li</b>
<span class="text-stone-500 animate-blink"></span></a></p><ul style=padding:0;margin:0><li><a href=/cv/><span>CV</span></a><li><a href=/posts/><span>Posts</span></a><li><a href=/about/><span>About</span></a></li></ul></header><hr class=hr-list style=padding:0;margin:0><section><h2 class=post>Machine Learning Notes: GNN, GraphNeT</h2><div class=toc><nav id=TableOfContents><ul><li><a href=#1-graph>§1 Graph</a><ul><li><a href=#11-graph--matrix>§1.1 Graph & Matrix</a></li></ul></li><li><a href=#2-gnn-pytorch-geometric-style>§2 GNN (<code>PyTorch Geometric</code> Style)</a><ul><li><a href=#21-torch_geometricutils>§2.1 <code>torch_geometric.utils</code></a></li><li><a href=#22-torch_geometricnnconv>§2.2 <code>torch_geometric.nn.conv</code></a></li></ul></li><li><a href=#3-graphnet>§3 <code>GraphNeT</code></a><ul><li><a href=#31-shape-of-the-data>§3.1 Shape of the Data</a></li><li><a href=#32-graphnetmodelsgnn>§3.2 <code>graphnet.models.gnn</code></a></li></ul></li></ul></nav></div><h2 id=1-graph>§1 Graph</h2><p>A graph is a data structure that has the shape $\mathbb{R} ^{N \times P}$, where</p><ul><li>$N$ is the number of nodes. Note that $N$ might vary in a dataset, but we often use cutting or padding to get a uniform, normalized $N$.</li><li>$P$ is the number of features. Yes, the concept of &ldquo;features&rdquo; is similar to the concept of &ldquo;channels&rdquo; in CNNs.</li></ul><p>A picture $\mathbb{R}^{H \times W \times C}$ is of height $H$ and width $W$, thus the total number of pixels is $HW$, and each pixel has $C$ channels, commonly $C=1$ (grep channel) or $C=3$ (RGB channels). Now let&rsquo;s transform this picture into a graph $\mathbb{R}^{N \times P}$, where $N=HW$ is the total number of pixels. Thus $P=C+2$, which means the original position information is now encoded into the channels. What&rsquo;s more, graph can represent more than that, thus in a sense, a graph is a generalized picture.</p><h3 id=11-graph--matrix>§1.1 Graph & Matrix</h3><p>Graphs can be represented by adjacency matrix, which can be normalized into <a href=https://en.wikipedia.org/wiki/Frobenius_normal_form>Frobenius normal form</a>, see <a href=https://thepalindrome.org/p/matrices-and-graphs><em>Matrices and graphs</em> - by Tivadar Danka - The Palindrome</a>.</p><p><img src=https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F485ec4b4-6869-43bb-b17c-e2151a428dbe_1920x1080.png alt loading=lazy decoding=async class=full-width></p><p>Often, large part of the matrix is empty, which is called <a href=https://en.wikipedia.org/wiki/Sparse_matrix>Sparse matrix</a>.</p><h2 id=2-gnn-pytorch-geometric-style>§2 GNN (<code>PyTorch Geometric</code> Style)</h2><p>See <a href=https://distill.pub/2021/gnn-intro/><em>A Gentle Introduction to Graph Neural Networks</em> - Distill.pub</a>. The general idea is that after GNN, part of the nodes are highlighted and the number of features of each nodes can be different. This is in consistence with CNN, where parts of the picture is highlighted and the number of channels (RGB $\rightarrow$ many more) can be different (see <a href=https://poloclub.github.io/cnn-explainer/>CNN Explainer</a>).</p><p>Considering the popularity of LLMs, unsurprisingly, GNNs support Attention. For <a href=https://arxiv.org/abs/1710.10903>Graph Attention Networks (GAT)</a>, see <a href=https://nn.labml.ai/graphs/gat/index.html>Graph Attention Networks (GAT) (labml.ai)</a> and <a href=https://nn.labml.ai/graphs/gatv2/index.html>Graph Attention Networks v2 (GATv2) (labml.ai)</a>.</p><p>This section is a skinner implementation of <a href=https://github.com/pyg-team/pytorch_geometric><code>PyTorch Geometric</code></a> from scratch, which means it&rsquo;s NOT necessary to install the package, but I still recommend to do so for comparison:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip install torch_geometric
</span></span></code></pre></div><p>And we import <code>PyTorch</code> as before:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>torch</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>torch.nn</span> <span style=color:#00a8c8>as</span> <span style=color:#111>nn</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#111>torch.nn.functional</span> <span style=color:#00a8c8>as</span> <span style=color:#111>F</span>
</span></span></code></pre></div><h3 id=21-torch_geometricutils>§2.1 <code>torch_geometric.utils</code></h3><p><a href=https://pytorch-geometric.readthedocs.io/en/2.5.2/modules/utils.html><code>torch_geometric.utils</code></a></p><h4 id=211-add_self_loops>§2.1.1 <code>add_self_loops</code></h4><div class=tabset></div><ul><li><p><code>torch_geometric.utils.add_self_loops</code></p><p><a href=https://pytorch-geometric.readthedocs.io/en/2.5.2/modules/utils.html#torch_geometric.utils.add_self_loops><code>torch_geometric.utils.add_self_loops</code></a> is pretty self-explaining.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>torch_geometric.utils</span> <span style=color:#f92672>import</span> <span style=color:#111>add_self_loops</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>test_add_self_loops</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>rand</span><span style=color:#111>((</span><span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>))</span><span style=color:#75715e># [num_nodes, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>randint</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#111>size</span><span style=color:#f92672>=</span><span style=color:#111>(</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#ae81ff>7</span><span style=color:#111>))</span><span style=color:#75715e># [2, num_messages]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>_</span> <span style=color:#f92672>=</span> <span style=color:#111>add_self_loops</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#f92672>=</span><span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>test_add_self_loops</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>will get (note we get self loops here):</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tensor<span style=color:#f92672>([[</span>4, 9, 7, 9, 3, 6, 9, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>5, 7, 4, 2, 7, 1, 2, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span style=color:#f92672>]])</span>
</span></span><span style=display:flex><span>torch.Size<span style=color:#f92672>([</span>2, 17<span style=color:#f92672>])</span>
</span></span></code></pre></div></li><li><p><code>my_add_self_loops</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>my_add_self_loops</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#111>self_loops</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>arange</span><span style=color:#111>(</span><span style=color:#111>num_nodes</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>edge_index</span><span style=color:#f92672>.</span><span style=color:#111>dim</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self_loops</span> <span style=color:#f92672>=</span> <span style=color:#111>self_loops</span><span style=color:#f92672>.</span><span style=color:#111>repeat</span><span style=color:#111>(</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>elif</span> <span style=color:#111>edge_index</span><span style=color:#f92672>.</span><span style=color:#111>dim</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>3</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>batch_size</span> <span style=color:#f92672>=</span> <span style=color:#111>edge_index</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self_loops</span> <span style=color:#f92672>=</span> <span style=color:#111>self_loops</span><span style=color:#f92672>.</span><span style=color:#111>repeat</span><span style=color:#111>(</span><span style=color:#111>batch_size</span><span style=color:#111>,</span> <span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>raise</span> <span style=color:#75af00>RuntimeError</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#39;The dimension of edge_index should be 2 or 3. Got: </span><span style=color:#d88200>{</span><span style=color:#111>edge_index</span><span style=color:#f92672>.</span><span style=color:#111>dim</span><span style=color:#111>()</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>cat</span><span style=color:#111>((</span><span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>self_loops</span><span style=color:#111>),</span> <span style=color:#111>dim</span><span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_weight</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>None</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>edge_weight</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>test_add_self_loops</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>rand</span><span style=color:#111>((</span><span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>))</span><span style=color:#75715e># [num_nodes, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>randint</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#111>size</span><span style=color:#f92672>=</span><span style=color:#111>(</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#ae81ff>7</span><span style=color:#111>))</span><span style=color:#75715e># [2, num_messages]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>_</span> <span style=color:#f92672>=</span> <span style=color:#111>my_add_self_loops</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#f92672>=</span><span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>rand</span><span style=color:#111>((</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>))</span><span style=color:#75715e># [batch_size, num_nodes, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>randint</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#111>size</span><span style=color:#f92672>=</span><span style=color:#111>(</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#ae81ff>7</span><span style=color:#111>))</span><span style=color:#75715e># [batch_size, 2, num_messages]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>_</span> <span style=color:#f92672>=</span> <span style=color:#111>my_add_self_loops</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#f92672>=</span><span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#111>])</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>test_add_self_loops</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>will get:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tensor<span style=color:#f92672>([[</span>0, 5, 2, 7, 8, 8, 5, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0, 2, 6, 6, 9, 6, 3, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span style=color:#f92672>]])</span>
</span></span><span style=display:flex><span>torch.Size<span style=color:#f92672>([</span>2, 17<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>([[[</span>5, 7, 2, 4, 9, 8, 1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>5, 3, 3, 7, 0, 1, 9, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span style=color:#f92672>]]</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[[</span>9, 0, 4, 7, 4, 9, 1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>6, 2, 9, 7, 7, 4, 6, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span style=color:#f92672>]]</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[[</span>4, 5, 4, 2, 0, 3, 9, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>1, 9, 7, 4, 9, 4, 5, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9<span style=color:#f92672>]]])</span>
</span></span><span style=display:flex><span>torch.Size<span style=color:#f92672>([</span>3, 2, 17<span style=color:#f92672>])</span>
</span></span></code></pre></div></li></ul><h4 id=212-scatter>§2.1.2 <code>scatter</code></h4><p><a href=https://pytorch-geometric.readthedocs.io/en/2.5.2/modules/utils.html#torch_geometric.utils.scatter><code>torch_geometric.utils.scatter</code></a> is the same as <a href=https://pytorch-geometric.readthedocs.io/en/2.5.2/modules/nn.html#aggregation-operators>Aggregation Operators</a>. Below is the image from <a href=https://pytorch-scatter.readthedocs.io/en/latest/functions/scatter.html>Scatter — pytorch_scatter 2.1.1 documentation</a>:</p><p><img src="https://raw.githubusercontent.com/rusty1s/pytorch_scatter/master/docs/source/_figures/add.svg?sanitize=true" alt=scatter loading=lazy decoding=async class=full-width></p><div class=tabset></div><ul><li><p><code>torch_geometric.utils.scatter</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> <span style=color:#111>torch_geometric.utils</span> <span style=color:#f92672>import</span> <span style=color:#111>scatter</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>test_scatter</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>rand</span><span style=color:#111>((</span><span style=color:#ae81ff>5</span><span style=color:#111>,</span> <span style=color:#ae81ff>8</span><span style=color:#111>))</span><span style=color:#75715e># [num_index, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>index</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>randint</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>,</span> <span style=color:#111>size</span><span style=color:#f92672>=</span><span style=color:#111>(</span><span style=color:#ae81ff>5</span><span style=color:#111>,))</span><span style=color:#75715e># [num_index,]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>index</span><span style=color:#111>,</span> <span style=color:#111>dim</span><span style=color:#f92672>=-</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#111>dim_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#111>reduce</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;sum&#39;</span><span style=color:#111>)</span><span style=color:#75715e># [dim_size, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>test_scatter</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>will get:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tensor<span style=color:#f92672>([[</span>0.0101, 0.3919, 0.6275, 0.1619, 0.2756, 0.9814, 0.5278, 0.9113<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.1170, 0.4807, 0.8374, 0.6121, 0.1399, 0.3740, 0.4485, 0.0578<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.7961, 0.2162, 0.8050, 0.2520, 0.2318, 0.0279, 0.9750, 0.3881<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.2107, 0.2072, 0.8769, 0.7675, 0.2437, 0.6953, 0.2572, 0.4149<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.6781, 0.9938, 0.4502, 0.1818, 0.2886, 0.2952, 0.1135, 0.9759<span style=color:#f92672>]])</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>([</span>3, 0, 3, 1, 1<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>([[</span>0.1170, 0.4807, 0.8374, 0.6121, 0.1399, 0.3740, 0.4485, 0.0578<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.8888, 1.2010, 1.3271, 0.9493, 0.5323, 0.9904, 0.3706, 1.3908<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.8061, 0.6080, 1.4325, 0.4139, 0.5074, 1.0093, 1.5027, 1.2994<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]])</span>
</span></span></code></pre></div></li><li><p><code>my_scatter</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>my_scatter</span><span style=color:#111>(</span><span style=color:#111>input</span><span style=color:#111>,</span> <span style=color:#111>index</span><span style=color:#111>,</span> <span style=color:#111>dim_size</span><span style=color:#111>,</span> <span style=color:#111>reduce</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;sum&#39;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>input</span><span style=color:#f92672>.</span><span style=color:#111>dim</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span><span style=color:#111>:</span><span style=color:#75715e># [num_index, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>num_index</span><span style=color:#111>,</span> <span style=color:#111>in_channels</span> <span style=color:#f92672>=</span> <span style=color:#111>input</span><span style=color:#f92672>.</span><span style=color:#111>shape</span>
</span></span><span style=display:flex><span>        <span style=color:#111>output</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>zeros</span><span style=color:#111>(</span><span style=color:#111>dim_size</span><span style=color:#111>,</span> <span style=color:#111>in_channels</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># if reduce == &#39;sum&#39;:</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># for i in range(num_index):</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>#     output[index[i]] += input[i]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>index</span> <span style=color:#f92672>=</span> <span style=color:#111>index</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>in_channels</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># https://pytorch.org/docs/stable/generated/torch.Tensor.scatter_reduce_.html</span>
</span></span><span style=display:flex><span>        <span style=color:#111>output</span> <span style=color:#f92672>=</span> <span style=color:#111>output</span><span style=color:#f92672>.</span><span style=color:#111>scatter_reduce_</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>index</span><span style=color:#111>,</span> <span style=color:#111>input</span><span style=color:#111>,</span> <span style=color:#111>reduce</span><span style=color:#f92672>=</span><span style=color:#111>reduce</span><span style=color:#111>)</span><span style=color:#75715e># [dim_size, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>elif</span> <span style=color:#111>input</span><span style=color:#f92672>.</span><span style=color:#111>dim</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>3</span><span style=color:#111>:</span><span style=color:#75715e># [batch_size, num_index, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>batch_size</span><span style=color:#111>,</span> <span style=color:#111>num_index</span><span style=color:#111>,</span> <span style=color:#111>in_channels</span> <span style=color:#f92672>=</span> <span style=color:#111>input</span><span style=color:#f92672>.</span><span style=color:#111>shape</span>
</span></span><span style=display:flex><span>        <span style=color:#111>output</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>zeros</span><span style=color:#111>(</span><span style=color:#111>batch_size</span><span style=color:#111>,</span> <span style=color:#111>dim_size</span><span style=color:#111>,</span> <span style=color:#111>in_channels</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>index</span> <span style=color:#f92672>=</span> <span style=color:#111>index</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>in_channels</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>output</span> <span style=color:#f92672>=</span> <span style=color:#111>output</span><span style=color:#f92672>.</span><span style=color:#111>scatter_reduce_</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>index</span><span style=color:#111>,</span> <span style=color:#111>input</span><span style=color:#111>,</span> <span style=color:#111>reduce</span><span style=color:#f92672>=</span><span style=color:#111>reduce</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, dim_size, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>raise</span> <span style=color:#75af00>RuntimeError</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#39;The dimension of input should be 2 or 3. Got: </span><span style=color:#d88200>{</span><span style=color:#111>input</span><span style=color:#f92672>.</span><span style=color:#111>dim</span><span style=color:#111>()</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>output</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>test_scatter</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>rand</span><span style=color:#111>((</span><span style=color:#ae81ff>5</span><span style=color:#111>,</span> <span style=color:#ae81ff>8</span><span style=color:#111>))</span><span style=color:#75715e># [num_index, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>index</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>randint</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>,</span> <span style=color:#111>size</span><span style=color:#f92672>=</span><span style=color:#111>(</span><span style=color:#ae81ff>5</span><span style=color:#111>,))</span><span style=color:#75715e># [num_index,]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>y1</span> <span style=color:#f92672>=</span> <span style=color:#111>scatter</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>index</span><span style=color:#111>,</span> <span style=color:#111>dim</span><span style=color:#f92672>=-</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#111>dim_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#111>reduce</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;sum&#39;</span><span style=color:#111>)</span><span style=color:#75715e># [dim_size, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>y1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>y2</span> <span style=color:#f92672>=</span> <span style=color:#111>my_scatter</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>index</span><span style=color:#111>,</span> <span style=color:#111>dim_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#111>reduce</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;sum&#39;</span><span style=color:#111>)</span><span style=color:#75715e># [dim_size, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>y2</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>all</span><span style=color:#111>(</span><span style=color:#111>y1</span><span style=color:#f92672>==</span><span style=color:#111>y2</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>rand</span><span style=color:#111>((</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>,</span> <span style=color:#ae81ff>8</span><span style=color:#111>))</span><span style=color:#75715e># [batch_size, num_index, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>index</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>randint</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>,</span> <span style=color:#111>size</span><span style=color:#f92672>=</span><span style=color:#111>(</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>))</span><span style=color:#75715e># [batch_size, num_index]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>my_scatter</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>index</span><span style=color:#111>,</span> <span style=color:#111>dim_size</span><span style=color:#f92672>=</span><span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#111>reduce</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;sum&#39;</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, dim_size, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>test_scatter</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>will get:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tensor<span style=color:#f92672>([[</span>0.2109, 0.7352, 0.5434, 0.3313, 0.4879, 0.1099, 0.9719, 0.5557<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.2895, 0.3029, 0.7941, 0.9762, 0.9781, 0.0098, 0.0681, 0.1918<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.9410, 0.4957, 0.7365, 0.7754, 0.3758, 0.8361, 0.3774, 0.7967<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.3614, 0.5214, 0.1778, 0.3030, 0.4437, 0.0416, 0.2726, 0.3489<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.9101, 0.3961, 0.2422, 0.6505, 0.8651, 0.4071, 0.2292, 0.7021<span style=color:#f92672>]])</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>([</span>2, 1, 2, 4, 0<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>([[</span>0.9101, 0.3961, 0.2422, 0.6505, 0.8651, 0.4071, 0.2292, 0.7021<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.2895, 0.3029, 0.7941, 0.9762, 0.9781, 0.0098, 0.0681, 0.1918<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>1.1520, 1.2309, 1.2798, 1.1066, 0.8637, 0.9460, 1.3493, 1.3524<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.3614, 0.5214, 0.1778, 0.3030, 0.4437, 0.0416, 0.2726, 0.3489<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]])</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>([[</span>0.9101, 0.3961, 0.2422, 0.6505, 0.8651, 0.4071, 0.2292, 0.7021<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.2895, 0.3029, 0.7941, 0.9762, 0.9781, 0.0098, 0.0681, 0.1918<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>1.1520, 1.2309, 1.2798, 1.1066, 0.8637, 0.9460, 1.3493, 1.3524<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.3614, 0.5214, 0.1778, 0.3030, 0.4437, 0.0416, 0.2726, 0.3489<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]])</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>(</span>True<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>([[[</span>0.8990, 0.4597, 0.7653, 0.6775, 0.3636, 0.4298, 0.3261, 0.9486<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0308, 0.8333, 0.0035, 0.3883, 0.8613, 0.2124, 0.4893, 0.1022<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.3727, 0.3074, 0.8212, 0.8106, 0.0155, 0.6888, 0.7277, 0.7075<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.7739, 0.0090, 0.2914, 0.3589, 0.1572, 0.0859, 0.1171, 0.6445<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0477, 0.5978, 0.1796, 0.8697, 0.8681, 0.3389, 0.8583, 0.2979<span style=color:#f92672>]]</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[[</span>0.4149, 0.0501, 0.1444, 0.3398, 0.8869, 0.3870, 0.7668, 0.9858<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.4371, 0.0038, 0.9366, 0.7123, 0.5654, 0.9842, 0.3148, 0.0612<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.3490, 0.4695, 0.7684, 0.2278, 0.1113, 0.5987, 0.1896, 0.7463<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.9775, 0.8479, 0.6687, 0.1694, 0.2184, 0.3508, 0.8931, 0.6718<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.9636, 0.9075, 0.9465, 0.2474, 0.2375, 0.7783, 0.7889, 0.4870<span style=color:#f92672>]]</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[[</span>0.0773, 0.0997, 0.9874, 0.8786, 0.8156, 0.3476, 0.5336, 0.7997<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.7374, 0.0760, 0.2192, 0.4114, 0.4912, 0.9106, 0.7786, 0.3500<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.2275, 0.8594, 0.7933, 0.2454, 0.1883, 0.9494, 0.1048, 0.1753<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.2489, 0.6791, 0.8371, 0.2103, 0.7531, 0.4672, 0.4845, 0.8223<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.8476, 0.1368, 0.2671, 0.2773, 0.9175, 0.1492, 0.9960, 0.9908<span style=color:#f92672>]]])</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>([[</span>0, 4, 1, 2, 3<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>2, 3, 0, 0, 1<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>2, 1, 0, 2, 4<span style=color:#f92672>]])</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>([[[</span>0.8990, 0.4597, 0.7653, 0.6775, 0.3636, 0.4298, 0.3261, 0.9486<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.3727, 0.3074, 0.8212, 0.8106, 0.0155, 0.6888, 0.7277, 0.7075<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.7739, 0.0090, 0.2914, 0.3589, 0.1572, 0.0859, 0.1171, 0.6445<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0477, 0.5978, 0.1796, 0.8697, 0.8681, 0.3389, 0.8583, 0.2979<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0308, 0.8333, 0.0035, 0.3883, 0.8613, 0.2124, 0.4893, 0.1022<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]]</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[[</span>1.3265, 1.3174, 1.4372, 0.3971, 0.3298, 0.9495, 1.0827, 1.4180<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.9636, 0.9075, 0.9465, 0.2474, 0.2375, 0.7783, 0.7889, 0.4870<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.4149, 0.0501, 0.1444, 0.3398, 0.8869, 0.3870, 0.7668, 0.9858<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.4371, 0.0038, 0.9366, 0.7123, 0.5654, 0.9842, 0.3148, 0.0612<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]]</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[[</span>0.2275, 0.8594, 0.7933, 0.2454, 0.1883, 0.9494, 0.1048, 0.1753<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.7374, 0.0760, 0.2192, 0.4114, 0.4912, 0.9106, 0.7786, 0.3500<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.3263, 0.7788, 1.8245, 1.0889, 1.5687, 0.8148, 1.0181, 1.6220<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.8476, 0.1368, 0.2671, 0.2773, 0.9175, 0.1492, 0.9960, 0.9908<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000<span style=color:#f92672>]]])</span>
</span></span></code></pre></div></li></ul><h4 id=213-knn_graph>§2.1.3 <code>knn_graph</code></h4><p><a href=https://pytorch-geometric.readthedocs.io/en/latest/generated/torch_geometric.nn.pool.knn_graph.html><code>torch_geometric.nn.pool.knn_graph</code></a>. Euclidean distances is similar to Attention.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>my_knn_graph</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#111>loop</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>,</span> <span style=color:#111>cosine</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>,</span> <span style=color:#111>xyz</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>dim</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span><span style=color:#111>:</span><span style=color:#75715e># [num_nodes, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>squeeze_at_the_end</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>True</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>elif</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>dim</span><span style=color:#111>()</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>3</span><span style=color:#111>:</span><span style=color:#75715e># [batch_size, num_nodes, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>squeeze_at_the_end</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>False</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>else</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#75af00>RuntimeError</span><span style=color:#111>(</span><span style=color:#d88200>f</span><span style=color:#d88200>&#39;The dimension of x should be 2 or 3. Got: </span><span style=color:#d88200>{</span><span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>dim</span><span style=color:#111>()</span><span style=color:#d88200>}</span><span style=color:#d88200>&#39;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>batch_size</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#111>,</span> <span style=color:#111>_</span> <span style=color:#f92672>=</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># pick out [batch_size, num_nodes, 3]. In this case, 3 stands for x, y, z.</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>xyz</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>x</span><span style=color:#111>[:,</span> <span style=color:#111>:,</span> <span style=color:#111>:</span><span style=color:#ae81ff>3</span><span style=color:#111>]</span><span style=color:#75715e># [batch_size, num_nodes, 3]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>cosine</span><span style=color:#111>:</span><span style=color:#75715e># cosine distances</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_norm</span> <span style=color:#f92672>=</span> <span style=color:#111>x</span> <span style=color:#f92672>/</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>norm</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>dim</span><span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>keepdim</span><span style=color:#f92672>=</span><span style=color:#00a8c8>True</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>similarities</span> <span style=color:#f92672>=</span> <span style=color:#111>x_norm</span> <span style=color:#f92672>@</span> <span style=color:#111>x_norm</span><span style=color:#f92672>.</span><span style=color:#111>transpose</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>distances</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>-</span> <span style=color:#111>similarities</span><span style=color:#75715e># [batch_size, num_nodes, num_nodes]</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>else</span><span style=color:#111>:</span><span style=color:#75715e># Euclidean distances</span>
</span></span><span style=display:flex><span>        <span style=color:#111>distances</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>cdist</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, num_nodes]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># if `True`, contain self loops</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#f92672>not</span> <span style=color:#111>loop</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>mask</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>eye</span><span style=color:#111>(</span><span style=color:#111>num_nodes</span><span style=color:#111>,</span> <span style=color:#111>dtype</span><span style=color:#f92672>=</span><span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>bool</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#ae81ff>0</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>distances</span><span style=color:#f92672>.</span><span style=color:#111>masked_fill_</span><span style=color:#111>(</span><span style=color:#111>mask</span><span style=color:#111>,</span> <span style=color:#111>float</span><span style=color:#111>(</span><span style=color:#d88200>&#39;inf&#39;</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># k neighbors</span>
</span></span><span style=display:flex><span>    <span style=color:#111>_</span><span style=color:#111>,</span> <span style=color:#111>indices</span> <span style=color:#f92672>=</span> <span style=color:#111>distances</span><span style=color:#f92672>.</span><span style=color:#111>topk</span><span style=color:#111>(</span><span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#111>k</span><span style=color:#111>,</span> <span style=color:#111>dim</span><span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>largest</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, k]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># concat, source to target</span>
</span></span><span style=display:flex><span>    <span style=color:#111>row</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>arange</span><span style=color:#111>(</span><span style=color:#111>num_nodes</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>view</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>repeat</span><span style=color:#111>(</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>k</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>view</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>repeat</span><span style=color:#111>(</span><span style=color:#111>batch_size</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, 1, num_nodes * k]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>col</span> <span style=color:#f92672>=</span> <span style=color:#111>indices</span><span style=color:#f92672>.</span><span style=color:#111>view</span><span style=color:#111>(</span><span style=color:#111>batch_size</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, 1, num_nodes * k]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>cat</span><span style=color:#111>([</span><span style=color:#111>row</span><span style=color:#111>,</span> <span style=color:#111>col</span><span style=color:#111>],</span> <span style=color:#111>dim</span><span style=color:#f92672>=-</span><span style=color:#ae81ff>2</span><span style=color:#111>)</span>  <span style=color:#75715e># [batch_size, 2, num_nodes * k]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>squeeze_at_the_end</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>edge_index</span><span style=color:#f92672>.</span><span style=color:#111>squeeze</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>edge_index</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>def</span> <span style=color:#75af00>test_knn_graph</span><span style=color:#111>():</span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>rand</span><span style=color:#111>(</span><span style=color:#ae81ff>5</span><span style=color:#111>,</span> <span style=color:#ae81ff>8</span><span style=color:#111>)</span><span style=color:#75715e># [num_nodes, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>my_knn_graph</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>)</span><span style=color:#75715e># [2, num_messages] = [2, num_nodes * k]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>rand</span><span style=color:#111>(</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>5</span><span style=color:#111>,</span> <span style=color:#ae81ff>8</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, in_channels]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>my_knn_graph</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, 2, num_messages] = [batch_size, 2, num_nodes * k]</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#111>test_knn_graph</span><span style=color:#111>()</span>
</span></span></code></pre></div><p>will get:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>tensor<span style=color:#f92672>([[</span>0, 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>[</span>2, 1, 4, 3, 2, 0, 1, 0, 3, 1, 2, 0, 0, 2, 1<span style=color:#f92672>]])</span>
</span></span><span style=display:flex><span>torch.Size<span style=color:#f92672>([</span>2, 15<span style=color:#f92672>])</span>
</span></span><span style=display:flex><span>tensor<span style=color:#f92672>([[[</span>0, 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>3, 1, 2, 2, 3, 0, 3, 1, 0, 2, 0, 4, 3, 2, 1<span style=color:#f92672>]]</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[[</span>0, 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>3, 2, 4, 4, 3, 2, 3, 4, 1, 2, 4, 0, 2, 3, 1<span style=color:#f92672>]]</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>[[</span>0, 0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4<span style=color:#f92672>]</span>,
</span></span><span style=display:flex><span>         <span style=color:#f92672>[</span>1, 3, 2, 0, 4, 2, 4, 3, 0, 4, 0, 2, 3, 2, 0<span style=color:#f92672>]]])</span>
</span></span><span style=display:flex><span>torch.Size<span style=color:#f92672>([</span>3, 2, 15<span style=color:#f92672>])</span>
</span></span></code></pre></div><h3 id=22-torch_geometricnnconv>§2.2 <code>torch_geometric.nn.conv</code></h3><h4 id=221-messagepassing>§2.2.1 <code>MessagePassing</code></h4><p>| <a href=https://pytorch-geometric.readthedocs.io/en/latest/tutorial/create_gnn.html><em>Creating Message Passing Networks</em></a> | <a href=https://pytorch-geometric.readthedocs.io/en/latest/generated/torch_geometric.nn.conv.MessagePassing.html><code>torch_geometric.nn.conv.MessagePassing</code></a> |</p><p>With $x_i \in R^F$ denoting node features of node $i$ and $e_{j, i} \in R^D$ denoting (optional) edge features from node $j$ to node $i$, message passing GNNs can be described as $$x_i^{\prime} = \gamma ( x_i,
\bigoplus_{j \in \mathcal{N}(i)} , \phi
(x_i, x_j,e_{j,i}) ),$$where</p><ul><li>$\phi$: <code>MessagePassing.message()</code></li><li>$\bigoplus$: <code>MessagePassing.aggregate()</code></li><li>$\gamma$: <code>MessagePassing.update()</code></li></ul><p>Below is <code>MyMessagePassing</code>, later in this article <code>TAGConv</code> and <code>EdgeConv</code> are subclasses of this class.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>no_batch_MyMessagePassing</span><span style=color:#111>(</span><span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>Module</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>aggr</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;sum&#39;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>super</span><span style=color:#111>()</span><span style=color:#f92672>.</span><span style=color:#111>__init__</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>aggr</span> <span style=color:#f92672>=</span> <span style=color:#111>aggr</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>message</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>row</span><span style=color:#111>,</span> <span style=color:#111>col</span> <span style=color:#f92672>=</span> <span style=color:#111>edge_index</span><span style=color:#75715e># both [num_messages,]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_i</span><span style=color:#111>,</span> <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>x</span><span style=color:#111>[</span><span style=color:#111>row</span><span style=color:#111>],</span> <span style=color:#111>x</span><span style=color:#111>[</span><span style=color:#111>col</span><span style=color:#111>]</span><span style=color:#75715e># both [num_messages, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>x_j</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>aggregate</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x_j</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>row</span><span style=color:#111>,</span> <span style=color:#111>col</span> <span style=color:#f92672>=</span> <span style=color:#111>edge_index</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>my_scatter</span><span style=color:#111>(</span><span style=color:#111>x_j</span><span style=color:#111>,</span> <span style=color:#111>col</span><span style=color:#111>,</span> <span style=color:#111>dim_size</span><span style=color:#f92672>=</span><span style=color:#111>num_nodes</span><span style=color:#111>,</span> <span style=color:#111>reduce</span><span style=color:#f92672>=</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>aggr</span><span style=color:#111>)</span><span style=color:#75715e># [num_nodes, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>x_j</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>update</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x_j</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>x_j</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>propagate</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#f92672>=</span><span style=color:#00a8c8>None</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>num_nodes</span> <span style=color:#f92672>=</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#111>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>edge_index</span> <span style=color:#f92672>is</span> <span style=color:#00a8c8>None</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>zeros</span><span style=color:#111>((</span><span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>),</span> <span style=color:#111>dtype</span><span style=color:#f92672>=</span><span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>int64</span><span style=color:#111>)</span><span style=color:#75715e># [2, num_messages]</span>
</span></span><span style=display:flex><span>            <span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>_</span> <span style=color:#f92672>=</span> <span style=color:#111>my_add_self_loops</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#f92672>=</span><span style=color:#111>num_nodes</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>message</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>aggregate</span><span style=color:#111>(</span><span style=color:#111>x_j</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>update</span><span style=color:#111>(</span><span style=color:#111>x_j</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>x_j</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>forward</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>propagate</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>MyMessagePassing</span><span style=color:#111>(</span><span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>Module</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>aggr</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;sum&#39;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>super</span><span style=color:#111>()</span><span style=color:#f92672>.</span><span style=color:#111>__init__</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>aggr</span> <span style=color:#f92672>=</span> <span style=color:#111>aggr</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>message</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>row</span><span style=color:#111>,</span> <span style=color:#111>col</span> <span style=color:#f92672>=</span> <span style=color:#111>edge_index</span><span style=color:#111>[:,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>:],</span> <span style=color:#111>edge_index</span><span style=color:#111>[:,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>:]</span><span style=color:#75715e># both [batch_size, num_messages]</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># torch do not support `x_i = x[row]` in this case, so here&#39;s the alternative:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_i</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>gather</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>row</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]))</span><span style=color:#75715e># [batch_size, num_messages, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>gather</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>col</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]))</span><span style=color:#75715e># [batch_size, num_messages, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>x_j</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>aggregate</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x_j</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>row</span><span style=color:#111>,</span> <span style=color:#111>col</span> <span style=color:#f92672>=</span> <span style=color:#111>edge_index</span><span style=color:#111>[:,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>:],</span> <span style=color:#111>edge_index</span><span style=color:#111>[:,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>:]</span><span style=color:#75715e># both [batch_size, num_messages]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>my_scatter</span><span style=color:#111>(</span><span style=color:#111>x_j</span><span style=color:#111>,</span> <span style=color:#111>col</span><span style=color:#111>,</span> <span style=color:#111>dim_size</span><span style=color:#f92672>=</span><span style=color:#111>num_nodes</span><span style=color:#111>,</span> <span style=color:#111>reduce</span><span style=color:#f92672>=</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>aggr</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>x_j</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>update</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x_j</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>x_j</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>propagate</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#f92672>=</span><span style=color:#00a8c8>None</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>batch_size</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#111>,</span> <span style=color:#111>_</span> <span style=color:#f92672>=</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>if</span> <span style=color:#111>edge_index</span> <span style=color:#f92672>is</span> <span style=color:#00a8c8>None</span><span style=color:#111>:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>zeros</span><span style=color:#111>((</span><span style=color:#111>batch_size</span><span style=color:#111>,</span> <span style=color:#ae81ff>2</span><span style=color:#111>,</span> <span style=color:#ae81ff>0</span><span style=color:#111>),</span> <span style=color:#111>dtype</span><span style=color:#f92672>=</span><span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>int64</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, 2, num_messages]</span>
</span></span><span style=display:flex><span>            <span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>_</span> <span style=color:#f92672>=</span> <span style=color:#111>my_add_self_loops</span><span style=color:#111>(</span><span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#f92672>=</span><span style=color:#111>num_nodes</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>message</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>aggregate</span><span style=color:#111>(</span><span style=color:#111>x_j</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>,</span> <span style=color:#111>num_nodes</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>update</span><span style=color:#111>(</span><span style=color:#111>x_j</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>x_j</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>forward</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>propagate</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span></code></pre></div><h4 id=222-tagconv>§2.2.2 <code>TAGConv</code></h4><p><a href=https://pytorch-geometric.readthedocs.io/en/latest/generated/torch_geometric.nn.conv.TAGConv.html><code>torch_geometric.nn.conv.TAGConv</code></a></p><p>TAGConv is defined as $$X^{\prime} = \sum_{k=0}^K \left( D^{-1/2} A
D^{-1/2} \right)^k X W_k,$$where $A$ denotes the adjacency matrix and $D_{ii} = \sum_{j=0} A_{ij}$ its diagonal degree matrix.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>MyTAGConv</span><span style=color:#111>(</span><span style=color:#111>MyMessagePassing</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>in_channels</span><span style=color:#111>,</span> <span style=color:#111>out_channels</span><span style=color:#111>,</span> <span style=color:#111>K</span><span style=color:#f92672>=</span><span style=color:#ae81ff>4</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>super</span><span style=color:#111>()</span><span style=color:#f92672>.</span><span style=color:#111>__init__</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>linears</span> <span style=color:#f92672>=</span> <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>ModuleList</span><span style=color:#111>([</span>
</span></span><span style=display:flex><span>            <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>Linear</span><span style=color:#111>(</span><span style=color:#111>in_channels</span><span style=color:#111>,</span> <span style=color:#111>out_channels</span><span style=color:#111>,</span> <span style=color:#111>bias</span><span style=color:#f92672>=</span><span style=color:#00a8c8>False</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#00a8c8>for</span> <span style=color:#111>_</span> <span style=color:#f92672>in</span> <span style=color:#111>range</span><span style=color:#111>(</span><span style=color:#111>K</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>])</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>bias</span> <span style=color:#f92672>=</span> <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>Parameter</span><span style=color:#111>(</span><span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>empty</span><span style=color:#111>(</span><span style=color:#111>out_channels</span><span style=color:#111>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>forward</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>out</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>linears</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>](</span><span style=color:#111>x</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>for</span> <span style=color:#111>linear</span> <span style=color:#f92672>in</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>linears</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>:]:</span>
</span></span><span style=display:flex><span>            <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>propagate</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>            <span style=color:#111>out</span> <span style=color:#f92672>=</span> <span style=color:#111>out</span> <span style=color:#f92672>+</span> <span style=color:#111>linear</span><span style=color:#111>(</span><span style=color:#111>x_j</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>out</span> <span style=color:#f92672>=</span> <span style=color:#111>out</span> <span style=color:#f92672>+</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>bias</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>out</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>my_tag_conv</span> <span style=color:#f92672>=</span> <span style=color:#111>MyTAGConv</span><span style=color:#111>(</span><span style=color:#111>in_channels</span><span style=color:#f92672>=</span><span style=color:#ae81ff>16</span><span style=color:#111>,</span> <span style=color:#111>out_channels</span><span style=color:#f92672>=</span><span style=color:#ae81ff>32</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>randn</span><span style=color:#111>(</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, in_channels]</span>
</span></span><span style=display:flex><span><span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>my_knn_graph</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, 2, num_nodes * k] = [batch_size, 2, num_messages]</span>
</span></span><span style=display:flex><span><span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>my_tag_conv</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, out_channels]</span>
</span></span></code></pre></div><p>will get:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>torch.Size<span style=color:#f92672>([</span>3, 10, 32<span style=color:#f92672>])</span>
</span></span></code></pre></div><h4 id=223-edgeconv>§2.2.3 <code>EdgeConv</code></h4><p><a href=https://pytorch-geometric.readthedocs.io/en/latest/generated/torch_geometric.nn.conv.EdgeConv.html><code>torch_geometric.nn.conv.EdgeConv</code></a></p><p>EdgeConv is defined as $$x_i^{\prime} = \sum_{j \in \mathcal{N}(i)} h_{\mathbf{\Theta}}(x_i , x_j - x_i)$$ where $h_{\mathbf{\Theta}}$ denotes a neural network.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>MyEdgeConv</span><span style=color:#111>(</span><span style=color:#111>MyMessagePassing</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>nn</span><span style=color:#111>,</span> <span style=color:#111>aggr</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;max&#39;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>super</span><span style=color:#111>()</span><span style=color:#f92672>.</span><span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>aggr</span><span style=color:#f92672>=</span><span style=color:#111>aggr</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>nn</span> <span style=color:#f92672>=</span> <span style=color:#111>nn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>message</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>row</span><span style=color:#111>,</span> <span style=color:#111>col</span> <span style=color:#f92672>=</span> <span style=color:#111>edge_index</span><span style=color:#111>[:,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>:],</span> <span style=color:#111>edge_index</span><span style=color:#111>[:,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>:]</span><span style=color:#75715e># both [batch_size, num_messages]</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># torch do not support `x_i = x[row]` in this case, so here&#39;s the alternative:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_i</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>gather</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>row</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]))</span><span style=color:#75715e># [batch_size, num_messages, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>gather</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>col</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]))</span><span style=color:#75715e># [batch_size, num_messages, in_channels]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>cat</span><span style=color:#111>([</span><span style=color:#111>x_i</span><span style=color:#111>,</span> <span style=color:#111>x_j</span> <span style=color:#f92672>-</span> <span style=color:#111>x_i</span><span style=color:#111>],</span> <span style=color:#111>dim</span><span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, 2 * in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>nn</span><span style=color:#111>(</span><span style=color:#111>x_j</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>x_j</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>my_edge_conv</span> <span style=color:#f92672>=</span> <span style=color:#111>MyEdgeConv</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>Sequential</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>        <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>Linear</span><span style=color:#111>(</span><span style=color:#ae81ff>32</span><span style=color:#111>,</span> <span style=color:#ae81ff>64</span><span style=color:#111>),</span><span style=color:#75715e># [2 * in_channels, hidden_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>ReLU</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>        <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>Linear</span><span style=color:#111>(</span><span style=color:#ae81ff>64</span><span style=color:#111>,</span> <span style=color:#ae81ff>128</span><span style=color:#111>),</span><span style=color:#75715e># [hidden_channels, out_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>ReLU</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>randn</span><span style=color:#111>(</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, in_channels]</span>
</span></span><span style=display:flex><span><span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>my_knn_graph</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, 2, num_nodes * k] = [batch_size, 2, num_messages]</span>
</span></span><span style=display:flex><span><span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>my_edge_conv</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, out_channels]</span>
</span></span></code></pre></div><p>will get:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>torch.Size<span style=color:#f92672>([</span>3, 10, 128<span style=color:#f92672>])</span>
</span></span></code></pre></div><h2 id=3-graphnet>§3 <code>GraphNeT</code></h2><p>This section is a general introduction to GitHub repository <a href=https://github.com/graphnet-team/graphnet><code>GraphNeT</code></a>. See their <a href=https://github.com/graphnet-team/graphnet/blob/main/GETTING_STARTED.md>getting started document</a>, especially <a href=https://github.com/graphnet-team/graphnet/blob/main/GETTING_STARTED.md#example-energy-reconstruction-using-modelconfig>the example</a>. In the following article I will focus on the model rather than how to load the data or how to train the model with <code>pytorch-lightning</code>, and I will test these models with dummies. Because I just understand things better in this way and I haven&rsquo;t used these models in practice.</p><h3 id=31-shape-of-the-data>§3.1 Shape of the Data</h3><p>See <a href=https://github.com/graphnet-team/graphnet/blob/main/GETTING_STARTED.md#4-the-dataset-and-dataloader-classes>4. The <code>Dataset</code> and <code>DataLoader</code> classes</a> of the getting started document:</p><blockquote><ul><li><code>graph.x</code>: Node feature matrix with shape <code>[num_nodes, num_features]</code></li><li><code>graph.edge_index</code>: Graph connectivity in <a href=https://pytorch.org/docs/stable/sparse.html#sparse-coo-docs>COO format</a> with shape <code>[2, num_edges]</code> and type <code>torch.long</code> (by default this will be <code>None</code>, i.e., the nodes will all be disconnected).</li></ul></blockquote><h3 id=32-graphnetmodelsgnn>§3.2 <code>graphnet.models.gnn</code></h3><h4 id=321-convnet>§3.2.1 <code>ConvNet</code></h4><p><a href=https://github.com/graphnet-team/graphnet/blob/main/src/graphnet/models/gnn/convnet.py><code>graphnet.models.gnn.ConvNet</code></a> is based on <a href=https://pytorch-geometric.readthedocs.io/en/latest/generated/torch_geometric.nn.conv.TAGConv.html><code>torch_geometric.nn.TAGConv</code></a>. For the structure of the model, see Fig.3 of <a href=https://arxiv.org/abs/2107.12187>[2107.12187] <em>Reconstruction of Neutrino Events in IceCube using Graph Neural Networks</em></a>.</p><p><img src=https://ar5iv.labs.arxiv.org/html/2107.12187/assets/graphics/architecture_small.png alt loading=lazy decoding=async class=full-width></p><p>In [2107.12187], it&rsquo;s stated that:</p><blockquote><p>In the simplest way, each pulse can be described by following quantities: the hit DOM, and therefore the position of the pulse, collected charge, and time recorded. &mldr; We can then represent each event by a graph, with the nodes representing the pulses in an abstract 5-dimensional (or 12-dimensional for the Upgrade) space.</p></blockquote><p>Therefore, the event is an input matrix in the shape of <code>[number_of_pulses, 5]</code>, where <code>5</code> is x, y, z, time, charge.</p><h4 id=322-dynedge>§3.2.2 <code>DynEdge</code></h4><h5 id=3221-dynedgeconv>§3.2.2.1 <code>DynEdgeConv</code></h5><p>The basic layer of <code>DynEdge</code> is <a href=https://github.com/graphnet-team/graphnet/blob/main/src/graphnet/models/components/layers.py><code>graphnet.models.components.layers.DynEdgeConv</code></a>, which is based on <a href=https://pytorch-geometric.readthedocs.io/en/latest/generated/torch_geometric.nn.conv.EdgeConv.html><code>torch_geometric.nn.EdgeConv</code></a>.</p><h5 id=3222-dynedge>§3.2.2.2 <code>DynEdge</code></h5><p><a href=https://github.com/graphnet-team/graphnet/blob/main/src/graphnet/models/gnn/dynedge.py><code>graphnet.models.gnn.DynEdge</code></a></p><h5 id=3223-dynedgejinst>§3.2.2.3 <code>DynEdgeJINST</code></h5><p><a href=https://github.com/graphnet-team/graphnet/blob/main/src/graphnet/models/gnn/dynedge_jinst.py><code>graphnet.models.gnn.DynEdgeJINST</code></a> is the model in Fig.2 of <a href=https://arxiv.org/abs/2209.03042>[2209.03042] <em>Graph Neural Networks for Low-Energy Event Classification & Reconstruction in IceCube</em></a>. <code>[n, 6]</code> in the figure means the number of nodes is <code>n</code> and the number of features is <code>6</code>, while <code>[1, n_outputs]</code> means the prediction of this event has <code>n_outputs</code> features (azimuth, zenith, energy, etc.)</p><p><img src=https://ar5iv.labs.arxiv.org/html/2209.03042/assets/x2.png alt loading=lazy decoding=async class=full-width></p><h5 id=3224-dynedgetito>§3.2.2.4 <code>DynEdgeTITO</code></h5><p>From <a href=https://www.kaggle.com/competitions/icecube-neutrinos-in-deep-ice/discussion/402976>1st Place Solution in the Kaggle Competition</a>.</p><p>The structure of this model is as follows:</p><ul><li><a href=https://github.com/graphnet-team/graphnet/blob/main/src/graphnet/models/gnn/dynedge_kaggle_tito.py><code>graphnet.models.gnn.DynEdgeTITO</code></a><ul><li><a href=https://github.com/graphnet-team/graphnet/blob/main/src/graphnet/models/components/layers.py#L115><code>graphnet.models.components.layers.DynTrans</code></a><ul><li><a href=https://github.com/graphnet-team/graphnet/blob/main/src/graphnet/models/components/layers.py#L70><code>graphnet.models.components.layers.EdgeConvTito</code></a></li><li><a href=https://pytorch.org/docs/stable/generated/torch.nn.TransformerEncoder.html><code>torch.nn.TransformerEncoder</code></a><ul><li><a href=https://pytorch.org/docs/stable/generated/torch.nn.TransformerEncoderLayer.html><code>torch.nn.TransformerEncoderLayer</code></a></li></ul></li></ul></li><li><code>graphnet.models.components.layers.DynTrans</code><ul><li><code>graphnet.models.components.layers.EdgeConvTito</code></li><li><code>torch.nn.TransformerEncoder</code><ul><li><code>torch.nn.TransformerEncoderLayer</code></li></ul></li></ul></li><li><code>graphnet.models.components.layers.DynTrans</code><ul><li><code>graphnet.models.components.layers.EdgeConvTito</code></li><li><code>torch.nn.TransformerEncoder</code><ul><li><code>torch.nn.TransformerEncoderLayer</code></li></ul></li></ul></li><li>Post-processing</li><li>Global pooling</li><li>Read-out</li></ul></li></ul><p>For <code>torch.nn.TransformerEncoderLayer</code>, <code>d_model=256</code> and <code>nhead=8</code>, and by default <code>dim_feedforward=2048</code>.</p><p>One of the layers <a href=https://github.com/graphnet-team/graphnet/blob/main/src/graphnet/models/components/layers.py#L70><code>graphnet.models.components.layers.EdgeConvTito</code></a> is a modification on <a href=https://pytorch-geometric.readthedocs.io/en/latest/generated/torch_geometric.nn.conv.EdgeConv.html><code>torch_geometric.nn.EdgeConv</code></a> (See §2.3.3): $$x_i^{\prime} = \sum_{j \in \mathcal{N}(i)} h_{\mathbf{\Theta}}(x_i , x_j - x_i , x_j)$$</p><p>Here we subclass <code>MyMessagePassing</code> to write it from scratch:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>MyEdgeConvTito</span><span style=color:#111>(</span><span style=color:#111>MyMessagePassing</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>nn</span><span style=color:#111>,</span> <span style=color:#111>aggr</span><span style=color:#f92672>=</span><span style=color:#d88200>&#39;max&#39;</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>super</span><span style=color:#111>()</span><span style=color:#f92672>.</span><span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>aggr</span><span style=color:#f92672>=</span><span style=color:#111>aggr</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>nn</span> <span style=color:#f92672>=</span> <span style=color:#111>nn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>def</span> <span style=color:#75af00>message</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>):</span>
</span></span><span style=display:flex><span>        <span style=color:#111>row</span><span style=color:#111>,</span> <span style=color:#111>col</span> <span style=color:#f92672>=</span> <span style=color:#111>edge_index</span><span style=color:#111>[:,</span> <span style=color:#ae81ff>0</span><span style=color:#111>,</span> <span style=color:#111>:],</span> <span style=color:#111>edge_index</span><span style=color:#111>[:,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>:]</span><span style=color:#75715e># both [batch_size, num_messages]</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># torch do not support `x_i = x[row]` in this case, so here&#39;s the alternative:</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_i</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>gather</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>row</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]))</span><span style=color:#75715e># [batch_size, num_messages, in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>gather</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>col</span><span style=color:#f92672>.</span><span style=color:#111>unsqueeze</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#f92672>.</span><span style=color:#111>expand</span><span style=color:#111>(</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>]))</span><span style=color:#75715e># [batch_size, num_messages, in_channels]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>cat</span><span style=color:#111>([</span><span style=color:#111>x_i</span><span style=color:#111>,</span> <span style=color:#111>x_j</span> <span style=color:#f92672>-</span> <span style=color:#111>x_i</span><span style=color:#111>,</span> <span style=color:#111>x_j</span><span style=color:#111>],</span> <span style=color:#111>dim</span><span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, 3 * in_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>x_j</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>nn</span><span style=color:#111>(</span><span style=color:#111>x_j</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#00a8c8>return</span> <span style=color:#111>x_j</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#111>my_edge_conv_tito</span> <span style=color:#f92672>=</span> <span style=color:#111>MyEdgeConvTito</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>    <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>Sequential</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>        <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>Linear</span><span style=color:#111>(</span><span style=color:#ae81ff>48</span><span style=color:#111>,</span> <span style=color:#ae81ff>64</span><span style=color:#111>),</span><span style=color:#75715e># [3 * in_channels, hidden_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>ReLU</span><span style=color:#111>(),</span>
</span></span><span style=display:flex><span>        <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>Linear</span><span style=color:#111>(</span><span style=color:#ae81ff>64</span><span style=color:#111>,</span> <span style=color:#ae81ff>128</span><span style=color:#111>),</span><span style=color:#75715e># [hidden_channels, out_channels]</span>
</span></span><span style=display:flex><span>        <span style=color:#111>nn</span><span style=color:#f92672>.</span><span style=color:#111>ReLU</span><span style=color:#111>()</span>
</span></span><span style=display:flex><span>    <span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>torch</span><span style=color:#f92672>.</span><span style=color:#111>randn</span><span style=color:#111>(</span><span style=color:#ae81ff>3</span><span style=color:#111>,</span> <span style=color:#ae81ff>10</span><span style=color:#111>,</span> <span style=color:#ae81ff>16</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, in_channels]</span>
</span></span><span style=display:flex><span><span style=color:#111>edge_index</span> <span style=color:#f92672>=</span> <span style=color:#111>my_knn_graph</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>k</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, 2, num_nodes * k] = [batch_size, 2, num_messages]</span>
</span></span><span style=display:flex><span><span style=color:#111>x</span> <span style=color:#f92672>=</span> <span style=color:#111>my_edge_conv_tito</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#111>,</span> <span style=color:#111>edge_index</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>print</span><span style=color:#111>(</span><span style=color:#111>x</span><span style=color:#f92672>.</span><span style=color:#111>shape</span><span style=color:#111>)</span><span style=color:#75715e># [batch_size, num_nodes, out_channels]</span>
</span></span></code></pre></div><p>will get:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>torch.Size<span style=color:#f92672>([</span>3, 10, 128<span style=color:#f92672>])</span>
</span></span></code></pre></div><div class=post-date><span class="g time">September 10, 2023</span> &#8729;
<a href=https://ChenLi2049.github.io/tags/programming/>programming</a></div></section><div id=comments><script src=https://utteranc.es/client.js repo=ChenLi2049/ChenLi2049.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script></div></div></main></body></html>